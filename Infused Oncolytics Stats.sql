declare @date datetime
set @date = dateadd(mm,datediff(m,0,convert(date, getdate()))-18,0)

SELECT
convert(date, trr.request_date_month) AS 'Month',
count(trr.request_id) AS 'Total Requests',
count(distinct trr.npi) AS 'Distinct NPIs',
count(distinct trr.submitting_user_id) AS 'Active Users',
count(trr.request_id)/cast(count(distinct trr.submitting_user_id) as float) AS 'PA Per User'

from common.dbo.vw_t_reporting_request_phi trr
join common.dbo.t_reporting_user u on trr.submitting_user_id = u.user_id

where trr.real = 1
and trr.request_date_month >= @date
and u.can_create_realpa = 1
AND trr.ddid IN
('092313',
'168617',
'083137',
'085994',
'132662',
'199562',
'100114',
'146834',
'175315',
'086250',
'086251',
'197425',
'184676',
'191353',
'199337',
'083019',
'083020',
'083021',
'002904',
'186749',
'200251',
'059058',
'092355',
'164857',
'025767',
'130521',
'091827',
'183669',
'183670',
'005721',
'190957',
'190968',
'043995',
'166292',
'166293',
'041755',
'161050',
'162230',
'162231',
'164697',
'164698',
'164700',
'174552',
'180036',
'187447',
'197778',
'191777',
'191778',
'191779',
'063351',
'007048',
'007050',
'078158',
'120922',
'129360',
'191110',
'191111',
'027181',
'123044',
'086168',
'128187',
'043683',
'044734',
'192578',
'146385',
'146386',
'181683',
'201313',
'201315',
'201316',
'201317',
'161948',
'057872',
'198027',
'010541',
'027920',
'076324',
'197916',
'197917',
'138687',
'149393',
'194921',
'131177',
'131178',
'156887',
'178012',
'178014',
'092037',
'185346',
'187107',
'199436',
'174821',
'193301',
'195473',
'196896',
'041040',
'196664',
'190465',
'201500',
'180686',
'013323',
'028791',
'199444',
'014915',
'190539',
'186869',
'186870',
'201223',
'138666',
'174017',
'045649',
'191302',
'017847',
'152788',
'067821',
'189794',
'189795',
'147040',
'192980',
'141611',
'031110',
'163886',
'128898',
'132894',
'133989',
'147723',
'186234',
'186235',
'069001',
'200756',
'189231',
'122325',
'122327',
'023421',
'023422',
'173387',
'023822',
'199256',
'192760',
'164961',
'164962',
'199968',
'160195',
'175139',
'175140',
'024092',
'097352')

group by
convert(date, trr.request_date_month)
ORDER BY CONVERT(date, trr.request_date_month)
